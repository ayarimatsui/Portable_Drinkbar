## Magicle ~Hack Your Taste~

＊ What is Magicle? *

中に入っているのはただの水ですが、クロスモーダル現象を利用し、視覚、嗅覚、聴覚、触覚に働きかけることによって、味覚をハックし、1本で複数の飲み物の味を楽しむことができるボトル型デバイスを製作しました。作品名に関しては、”magical”と”bottle”を組み合わせて”Magicle”としました。

![magicle_logo](https://github.com/ayarimatsui/Portable_Drinkbar/blob/master/images/magicle_logo.png)


# ＜原理＞

・概要
　まず、入力はユーザーによる音声入力またはキー入力で行います。再現できる味は全部で5種類あり、りんごジュース、紅茶(アールグレイ)、コーラ、ぶどうジュース、メロンソーダです。ユーザーが、飲みたいものを言う、またはキーで端末に入力すると、その味が楽しめる様に出力が変化します。
　入力が入ると、初めにボトルの色が以下の図1に示す様に、それぞれの飲み物に合った色に変化します。ここでは、フルカラーLEDを制御することによって色を変えています。
 
![image1](https://github.com/ayarimatsui/Portable_Drinkbar/blob/master/images/image1.png)


  ボトルには、蓋が開いているか閉じているかを検知するシステムを作っており、ボトルの蓋が開いていることを感知すると、ボトルの横に付いている香り噴出装置から入力の飲み物の香りが発生します。この香りを含んだ空気を、ボトルの中身の水と一緒にストローで吸うことによって、入力した飲み物を味わうことができます。(図2)
  
![image2](https://github.com/ayarimatsui/Portable_Drinkbar/blob/master/images/image2.png)

  また、入力がコーラまたはメロンソーダ、つまり炭酸飲料であった場合は、炭酸感を再現するために2つの工夫をしています。まず、ボトルの蓋を開ける際ですが、炭酸飲料の入ったペットボトルを開けるときの様な「シュッ」という音が蓋を開けたタイミングで再生される様にしています。さらに、蓋が開いた後、ボトルの内蓋(ストローを挿す部分)の中に埋め込まれたマイクロ振動モータを振動させることによって、挿したストローが振動し炭酸飲料の感触を再現できる様にしています。
  
  全体の流れをフローチャートにすると、以下の図の様になる。(図3)

![image3](https://github.com/ayarimatsui/Portable_Drinkbar/blob/master/images/image3.png)

　また、制御にはRaspberry Pi 3 Model Bを使用しました。

 メインファイルは、main6.pyであり、音声認識に使用するjuliusのサーバーを立ち上げた後にmain6.pyを実行することによって動きます。
 
 
＊実行手順
 
ターミナルで以下を実行

$ cd speech-recognition/sample
$ sudo modprobe snd-pcm-oss
$ julius -C ~/Portable_Drinkbar/speech-recognition/julius-4.4.2/julius-kits/grammar-kit-v4.1/hmm_mono.jconf -nostrip -input mic -gram ~/Portable_Drinkbar/speech-recognition/sample/drink -module &
(これでjuliusサーバーが立ち上がる)

別端末を立ち上げて、Portable_Drinkbar(ルートディレクトリ)で、
$ sudo python main6.py
を実行


・入力
　音声入力には「julius」という音声認識エンジンを利用しました。ユーザーが言った飲み物の単語を入力として受け取ります。辞書を作成することで特定の言葉に対する認識の精度を上げ、誤認識を減らすように工夫しました。マイクにはaudio-technicaのモノラルマイクロホンAT9904を使用しました。
  入力方法を音声入力のみにしてしまうと、マイクの故障によって入力ができなくなる、プレゼンテーション中に入力のつもりではない説明の言葉も拾って認識してしまう等の問題があったため、キーからの入力もできるようにしました。キー入力によって、音声認識を一時中断したり、再開したりもできるようにしました。
  音声入力、キーによる入力共に、メインのスレッドとは別のスレッドを立てて行うことで、入力のタイミングによってメインのプログラムが影響を受けないように工夫をしました。
  

・ボトルの色
　5V駆動の円形のフルカラーLED(waves WS2812B)の外径86mmで24個のLEDがリング状に並んでいるものと、直径23mmで7個のLEDが円上に配置されたものをボトルの底部分に取り付け、その色や光り方をRaspberry Piによって制御しました。プログラムでは、Portable_Drinkbar/make_color/make_color.pyの中でLEDの光り方を決めるクラスMakeColorを定義し、ここで定義したメソッドをメインファイルの中で、条件に合わせて呼び出すことで制御を行いました。Raspberry Piの出力電圧は3.3Vなので、GPIOピンから直接LEDには繋がずに、ロジックレベル変換ICを使用しました。


・蓋の開閉の検知
　蓋の開閉の検知システムは以下に述べるような機構で実現しました。
　ボトルの内側の蓋に超小型マグネットスイッチのスイッチ部を埋め込み、外側の蓋の内側に磁石を取り付けました。(図4)今回使用したマグネットスイッチでは、スイッチ部とマグネット部が接触している間ではスイッチは開いて通電していない状態で、スイッチ部とマグネット部が離れるとスイッチが開いて通電します。ボトルの蓋を回すとマグネットスイッチのスイッチ部と磁石が近づいたり遠ざかったりすることを利用して、蓋の開閉を検知する仕組みです。マグネットスイッチのスイッチ部は、竹中エンジニアリングの超小型マグネットスイッチを利用し、マグネット部には直径6mmのボタン型の磁石を使用しました。

![image4](https://github.com/ayarimatsui/Portable_Drinkbar/blob/master/images/image4.png)

  プログラムでは、Portable_Drinkbar/detect_open/detect_open.pyの中で、蓋の開閉を調べるクラスDetectOpenを定義し、そのメソッドをメインファイルの中で呼び出して蓋の開閉状況を確認できるようにしました。


・香り噴出装置
　ボトルの蓋が開いていることが検知されると、香り噴出装置が作動します。装置の中には、小型DCファンとファンの前に香料を染み込ませた脱脂綿を、味の種類の数だけ入れています。(図5)入力に応じて、該当する飲み物の香料の脱脂綿の後ろにあるファンが回ることで、入力された飲み物の香りが発生する仕組みです。香料は、製菓用に販売されているものを使用しました。噴出された香り付きの空気をストローで、ボトルの中の水と一緒に吸い込むことで、音声入力した飲み物の味を味わうことができます。装置外側の容器や、脱脂綿とDCファンを格納する容器は3Dプリンタで製作しました。DCファンを固定する板は、アクリル板をレーザーカッターで加工して製作しました。各DCファンは、20mm×20mm×10mmの寸法で、定格電圧5V、定格電流0.04Aのものを使用しました。DCファンを回すために十分な電流をRaspberry PiのGPIOピンから流すことはできないため、6Vの外部電源とトランジスタを用いて電流増幅回路を組み、Raspberry Piからファンの回転を制御できるようにしました。回路図は以下に示すようになります。(図6)

![image5](https://github.com/ayarimatsui/Portable_Drinkbar/blob/master/images/image5.png)

![image6](https://github.com/ayarimatsui/Portable_Drinkbar/blob/master/images/image6.png)

  プログラムでは、Portable_Drinkbar/make_aroma/make_aroma.pyの中で、DCファンの回転を制御するクラスMakeAromaを定義し、そのメソッドをメインファイルの中で呼び出して、入力に対応したファンを回すことができるようにしました。


・炭酸感の再現
　入力がコーラ、またはメロンソーダの場合は、炭酸らしさを再現するために次に述べるような機能を実装しました。
 
  ・ボトルの蓋を開けた時に、炭酸飲料のペットボトルの蓋を開けた時のような、「プシュッ」という音が鳴る。
  ・内側の蓋に埋め込んだマイクロ振動モータによって、ボトルに挿したストローが振動する。
  
　一つ目に関しては、ボトルの飲み口付近に小型の圧電スピーカーを取り付け、蓋の開閉検知システムによって蓋が開いたことが検知されると、その瞬間に、あらかじめ用意しておいた炭酸飲料の容器の蓋を開けた時の音源が再生されるようにすることで実装しました。音源の再生にはPygameのSoundを使用しました。
  二つ目に関しては、ボトルの蓋が開いている時に、内蓋に埋め込んだマイクロ振動モータが振動し、内蓋に挿したストローにその振動が伝わるようにしました。現実の炭酸飲料の振動に近いものを再現するために、炭酸飲料の音源を配列に変換し、それに基づいて振動するようにPWM制御を行いました。マイクロ振動モータはuxcellの定格電圧がDC 1.5V、3V、定格電流0.05A、0.1Aのものを使用しました。マイクロ振動モータも、DCファンと同様に、Raspberry PiのGPIOピンからの電力だけでは駆動しないので、DCファンと同様の外部電源、トランジスタ回路を用いて制御を行いました。
